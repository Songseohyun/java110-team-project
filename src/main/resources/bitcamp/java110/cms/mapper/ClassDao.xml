<?xml version="1.0" encoding="UTF-8"?>
<!-- MemberDao 클래스가 사용할 SQL이 들어 있는 파일 -->
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="bitcamp.java110.cms.dao.ClassDao">

    <resultMap type="Classes" id="classMap">
        <id 	column="cno" 		property="no"/>
        <result column="titl"  		property="titl"/>
        <result column="conts"    	property="conts"/>
        <result column="pric"   	property="pric"/>
        <result column="rgdt"   	property="rgdt"/>
        <result column="time"   	property="time"/>
        <result column="capa"  		property="capa"/>
        <result column="cfile"  	property="cfile"/>
        <result column="tinfo"    	property="tinfo"/>
        <result column="cinfo"   	property="cinfo"/>
        <result column="pstno"   	property="pstno"/>
        <result column="bas_addr"   property="basAddr"/>
        <result column="det_addr"   property="detAddr"/>
        <result column="edt"  		property="edt"/>
        <result column="mono"  		property="mono"/>
        <result column="mtno"  		property="mtno"/>
        <result column="star"		property="star"/>
        
        <result column="meno"		property="mentee.no"/>
        <result column="name"  		property="mentee.name"/>
        <result column="nick"		property="mentee.nick"/>
        <result column="phot"		property="mentee.phot"/>
        
        <result column="mtno"		property="middleTag.mtno"/>
        <result column="mtname"		property="middleTag.name"/>
        
        <result column="fname"		property="classFile.fname"/>
    </resultMap>
    
    <resultMap type="Classes" id="classMapOrigin">
        <id     column="cno"        property="no"/>
        <result column="titl"       property="titl"/>
        <result column="conts"      property="conts"/>
        <result column="pric"       property="pric"/>
        <result column="rgdt"       property="rgdt"/>
        <result column="time"       property="time"/>
        <result column="capa"       property="capa"/>
        <result column="cfile"      property="cfile"/>
        <result column="tinfo"      property="tinfo"/>
        <result column="cinfo"      property="cinfo"/>
        <result column="pstno"      property="pstno"/>
        <result column="bas_addr"   property="basAddr"/>
        <result column="det_addr"   property="detAddr"/>
        <result column="edt"        property="edt"/>
        <result column="mono"       property="mono"/>
        <result column="mtno"       property="mtno"/>
        <result column="star"       property="star"/>
        <result column="mtname"       property="middleTag.name"/>
        <result column="nick"       property="mentee.nick"/>
    </resultMap>
    
    <resultMap type="Classes" id="classMapMypage">
        <id     column="cno"        property="no"/>
        <result column="titl"       property="titl"/>
        <result column="btname"     property="bigTag.name"/>
        <result column="mtname"     property="middleTag.name"/>
        <result column="capa"       property="capa"/>
        <result column="ctcapa"     property="timetable.capa"/>
        <result column="me2name"    property="mentee2.name"/>
        <result column="me2nick"    property="mentee2.nick"/>
        <result column="me2phone"   property="mentee2.phone"/>
    </resultMap>
    
    
    <sql id="select1">
    	select 
			ps.cno,ps.titl,ps.pric,ps.bas_addr,pg.mtno,pe.meno
		from
			p_cls as ps inner join p_mete as pe 
				on ps.mono = pe.meno
			inner join p_mtag as pg 
				on ps.mtno = pg.mtno
    </sql>
	<select id="findAllList" resultMap="classMap">
		SELECT 
			ps.cno,
			ps.titl,
			ps.pric,
			pe.name,
            pe.nick,
            pe.phot,
			ps.bas_addr,
			pg.mtname,
			ps.cfile,
		    ps.star
		FROM
			p_mtag as pg inner join p_cls as ps
				on ps.mtno = pg.mtno
			inner join p_meto as po 
				on po.mono = ps.mono
			inner join p_mete as pe
				on po.mono = pe.meno
		order by ps.cno asc
	</select>
	
	<select id="findAllByList" resultMap="classMap"> <!-- 이게 전체리스트출력하는거임 -->
        select 
            cls.cno,
            mtag.mtname,
            cls.titl,
            mete.phot,
            mete.name,
            mete.nick,
            cls.pric,
            cls.rgdt

        from
            p_cls as cls 
            inner join p_mtag as mtag
            inner join p_cert as cert
            inner join p_mete as mete
            on cls.mtno = mtag.mtno and
            cls.cno = cert.cno and
            cert.meno = mete.meno
        order by 
            cls.cno desc
    </select>
 
    <select id="findAll" resultMap="classMap" parameterType="map">
        <include refid="select1"></include>
		order by
			cno asc;
    </select>
    
    <select id="findByptno" resultMap="classMap" parameterType="int">
    	select
			ps.cno,
			ps.titl,
			ps.pric,
			pe.name,
			ps.bas_addr,
			pg.mtname,
			ps.cfile,
			ps.star
		from
			p_cert as pct inner join p_prdt as ppt
				on ppt.ctno = pct.ctno
			inner join p_cls as ps
				on ps.cno = pct.cno
			inner join p_mtag as pg 
				on ps.mtno = pg.mtno
			inner join p_meto as po 
				on po.mono = ps.mono
			inner join p_mete as pe
				on po.mono = pe.meno
		where ppt.ptno = #{ptno}
    </select>

	<select id="findByCno" resultMap="classMap" parameterType="int">
		select
			ps.cno,
			pe.nick,
			ps.titl,
			ps.conts,
			ps.pric,
			ps.rgdt,
			ps.cfile,
			ps.time,
			ps.capa,
            ps.cfile,
			ps.tinfo,
			ps.cinfo,
			ps.pstno,
			ps.bas_addr,
			ps.det_addr,
			ps.edt,
            ps.star,
            ptg.mtname,
            pe.phot,
            pe.meno
		from
			p_cls as ps inner join p_meto as po
				on ps.mono = po.mono
			inner join p_mete as pe
				on po.mono = pe.meno
            inner join p_mtag as ptg
            	on ps.mtno = ptg.mtno
		where
			cno =  #{no}
	</select>

	<select id="findBytag" resultMap="classMap" parameterType="int">
		<include refid="select1"></include>
		where pg.mtno = #{mtno}
	</select>
	
	<select id ="findByba" resultMap="classMap" parameterType="String">
		<include refid="select1"></include>
		where bas_addr = #{bas_addr}
	</select>
    
    <insert id="classinsert" parameterType="Classes"
    useGeneratedKeys="true" keyColumn="cno" keyProperty="no">
        insert 
        	into p_cls(titl,conts,pric,rgdt,time,capa,cfile
        	,tinfo,cinfo,pstno,bas_addr,det_addr,edt,mono,mtno)
        values
        	(#{titl},#{conts},#{pric},now(),#{time},#{capa}
        	,#{cfile},#{tinfo},#{cinfo},#{pstno},#{basAddr}
        	,#{detAddr},now(),#{mono},#{mtno})
    </insert> 
    
    <update id="classupdate" parameterType="Classes">
    	update p_cls
    		<set>
    			<if test="titl != null">titl = #{titl},</if>
    			<if test="conts != null">conts = #{conts},</if>
    			<if test="pric > 0">pric = #{pric},</if>
    			<if test="rgdt != null">rgdt = now(),</if>
    			<if test="time != null">time = #{time},</if>
    			<if test="capa > 0">capa = #{capa},</if>
    			<if test="cfile != null">cfile = #{cfile},</if>
    			<if test="tinfo != null">tinfo = #{tinfo},</if>
    			<if test="cinfo != null">cinfo = #{cinfo},</if>
    			<if test="pstno != null">pstno = #{pstno},</if>
    			<if test="basAddr != null">bas_addr = #{basAddr},</if>
    			<if test="detAddr != null">det_addr = #{detAddr},</if>
    			<if test="edt != null">edt = now(),</if>
    			<if test="mono > 0">mono = #{mono},</if>
    			<if test="mtno > 0">mtno = #{mtno}</if>
    		</set>
    	where 
    		cno = #{no}
    </update>
    
    <select id="findByStat" resultMap="classMapOrigin" parameterType="string">
        SELECT
            *
        FROM
            p_cls
        where
            stat = #{stat}
        order by
            cno DESC;
    </select>
    
    
    
    
    <select id="findByMono" resultMap="classMapMypage" parameterType="map">
    
       SELECT
            c.titl,
            btg.btname,
            mtg.mtname,
            c.capa,
            ct.capa as ctcapa,
            me2.name as me2name,
            me2.nick as me2nick,
            me2.phone as me2phone
       <!--  cert.*,
            rept.* -->

       FROM  p_cls c
            JOIN p_meto mo ON c.mono = mo.mono
            JOIN p_mete me ON mo.mono = me.meno
            JOIN p_mtag mtg ON c.mtno = mtg.mtno
            JOIN p_btag btg ON mtg.btno = btg.btno
            JOIN p_cls_ttab ct ON c.cno = ct.cno
            JOIN p_cls_order co ON ct.cno = co.ctno
            JOIN p_mete me2 ON co.meno = me2.meno
            JOIN p_cert cert ON me2.meno = cert.meno
            JOIN p_rept rept ON me.meno = rept.meno
            
       where
            mo.mono=5;
       
    </select>
    
    
</mapper>









