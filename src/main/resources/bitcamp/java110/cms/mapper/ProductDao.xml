<?xml version="1.0" encoding="UTF-8"?>

<!-- ProductDao 클래스가 사용할 SQL이 들어 있는 파일 -->
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="bitcamp.java110.cms.dao.ProductDao">

    <resultMap type="product" id="productMap">
        <id column="ptno"        property="no"/>
        <result column="titl"   property="titl"/>
        <result column="conts"   property="conts"/>
        <result column="pric"   property="pric"/>
        <result column="rgdt"   property="rgdt"/>
        <result column="stock"   property="stock"/>
        <result column="pp"   property="phot"/>
        <result column="meno"   property="meno"/>
        <result column="ctno"   property="ctno"/>
        <result column="stno"   property="stno"/>
        <result column="star"   property="star"/>
        <result column="meno"   property="mentee.no"/>
        <result column="name"   property="mentee.name"/>
        <result column="nick"   property="mentee.nick"/>
        <result column="mp"   property="mentee.phot"/>
        <result column="ctno"   property="cert.no"/>
        <result column="type"   property="cert.type"/>
        
        <result column="stno"   property="smalltag.no"/>
        <result column="stname"   property="smalltag.name"/>
        <result column="mtno"   property="smalltag.mtno"/>
        
        <result column="mtname"   property="middleTagName"/>
        <result column="deli" property="deli"/>
        <result column="star" property="star"/>
        <result column="titl" property="classes.titl"/>
        <result column="cfile" property="classes.cfile"/>
        
    </resultMap>

    
    <select id="findAll_list" resultMap="productMap">
        select
    p.ptno,
    p.titl,
    p.conts,
    p.pric,
    p.deli,
    p.star,
    p.rgdt,
    p.stock,
    p.phot as pp,
    p.meno,
    p.ctno,
    p.stno,
    p.star,
    mete.meno,
    mete.nick,
    mete.name,
    mete.phot mp,
    cert.ctno,
    cert.type,
    stag.stno,
    stag.stname,
    stag.mtno,
    mtag.mtname
from 
    p_prdt p
    join p_mete mete
    join p_cert cert
    join p_stag stag
    JOIN p_mtag mtag
ON
    p.meno=mete.meno AND
    p.ctno=cert.ctno AND
    p.stno=stag.stno AND
    stag.mtno = mtag.mtno
order by 
    ptno DESC
    </select>
    
    <select id="findAllByList" resultMap="productMap">
    select
        prdt.ptno,
        stag.stname,
        prdt.titl, 
        mete.nick,
        mete.name,
        prdt.pric,
        prdt.stock,
        prdt.rgdt
    from
        p_prdt as prdt 
        inner join p_stag as stag
        inner join p_mete as mete

    on  prdt.stno = stag.stno and
        prdt.meno = mete.meno
     
    order by
        prdt.ptno asc
    </select>

    <select id="findByNo" 
            resultMap="productMap" parameterType="int">
        select
    p.ptno,
    p.titl,
    p.conts,
    p.pric,
    p.deli,
    p.star,
    p.rgdt,
    p.stock,
    p.phot pp,
    p.meno,
    p.ctno,
    p.stno,
    mete.meno,
    mete.nick,
    mete.name,
    mete.phot mp,
    cert.ctno,
    cert.type,
    stag.stno,
    stag.stname,
    stag.mtno,
    mtag.mtname,
    pcls.titl,
    pcls.cfile
from 
    p_prdt p
    join p_mete mete
    join p_cert cert
    join p_stag stag
    JOIN p_mtag mtag
    join p_cls pcls
ON
    p.meno=mete.meno AND
    p.ctno=cert.ctno AND
    p.stno=stag.stno AND
    stag.mtno = mtag.mtno AND
    pcls.cno= cert.cno 
where
    ptno=#{value}
    </select>
    
    <select id="findAllByMeno" 
            resultMap="productMap" parameterType="Map">
        select
            ptno,
            titl,
            conts,
            pric,
            deli,
            star,
            rgdt,
            stock,
            phot,
            meno,
            ctno,
            stno
        from
            p_prdt
        where 
            meno=#{mentno}
    </select>
    
    
    <select id="findAllByStno" 
            resultMap="productMap" parameterType="Map">
        select
            ptno,
            titl,
            conts,
            pric,
            deli,
            star,
            rgdt,
            stock,
            phot,
            meno,
            ctno,
            stno
        from
            p_prdt
        where 
            stno=#{smallno}
    </select>
    
    <insert id="insert" parameterType="product"
            useGeneratedKeys="true" keyColumn="ptno" keyProperty="no">
            
        insert into p_prdt(titl,conts,pric,rgdt,stock,phot,meno,ctno,stno,deli,star)
        values(#{titl},#{conts},#{pric},now(),#{stock},#{phot},#{meno},#{ctno},#{stno},#{deli},#{star})
    </insert> 
    
    <update id="update" parameterType="product">
    
    update p_prdt
    
    <set> 
        <if test="titl!=null">titl= #{titl},</if>
        <if test="conts!=null">conts=#{conts},</if>
        <if test="pric!=null">pric= #{pric},</if>
        <if test="deli!=null">deli= #{deli},</if>
        <if test="star>0">star= #{star},</if>
        <if test="stock>0">stock= #{stock},</if>
        <if test="phot!=null">phot= #{phot},</if>
        <if test="ctno>0">ctno= #{ctno},</if>
        <if test="stno>0">stno= #{stno},</if>
        
    </set>
        where
            ptno=#{no}
    </update>
    
</mapper>
